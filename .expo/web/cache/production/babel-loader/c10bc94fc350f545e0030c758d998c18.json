{"ast":null,"code":"import _toConsumableArray from\"@babel/runtime/helpers/toConsumableArray\";import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";import _objectWithoutProperties from\"@babel/runtime/helpers/objectWithoutProperties\";var _excluded=[\"children\"];function _extends(){_extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};return _extends.apply(this,arguments);}import dayjs from'dayjs';import React,{useCallback,useContext,useEffect,useImperativeHandle,useMemo,useRef,useState}from'react';import Platform from\"react-native-web/dist/exports/Platform\";import ScrollView from\"react-native-web/dist/exports/ScrollView\";import useWindowDimensions from\"react-native-web/dist/exports/useWindowDimensions\";import View from\"react-native-web/dist/exports/View\";import Animated,{FadeInDown,FadeOutUp}from'react-native-reanimated';import{useSafeAreaInsets}from'react-native-safe-area-context';import{DataProvider,LayoutProvider,RecyclerListView}from'recyclerlistview';import{ChatBubble}from\"./ChatBubble\";import{PropsContext}from\"./Chatty\";import{FAB}from\"./components/FAB\";import{LoadEarlier}from\"./components/LoadEarlier\";import{RenderDate}from\"./components/RenderDate\";import{TypingStatus}from\"./components/TypingStatus\";import{useHaptic}from\"./hooks/useHaptic\";import{usePrevious}from\"./hooks/usePrevious\";import{SwipeableBubble}from\"./SwipeableBubble\";import{HapticType,LayoutType}from\"./types/Chatty.types\";import{ChatBubbleEmitter}from\"./utils/eventEmitter\";import{hapticEngine}from\"./utils/hapticEngine\";import{wait}from\"./utils/helpers\";var ScrollViewWithHeader=React.forwardRef(function(_ref,ref){var children=_ref.children,props=_objectWithoutProperties(_ref,_excluded);var propsContext=useContext(PropsContext);return React.createElement(ScrollView,_extends({ref:ref},props),(propsContext===null||propsContext===void 0?void 0:propsContext.loadEarlierProps)&&propsContext.loadEarlierProps.show&&React.createElement(LoadEarlier,propsContext.loadEarlierProps),children);});export var List=React.forwardRef(function(props,ref){var propsContext=useContext(PropsContext);var recyclerlistviewRef=useRef();var windowDimensions=useWindowDimensions();var safeArea=useSafeAreaInsets();var _useHaptic=useHaptic(),trigger=_useHaptic.trigger;var fabRef=useRef(null);var typingStatusRef=useRef(null);var listHeight=useMemo(function(){return windowDimensions.height-150-safeArea.bottom-safeArea.top;},[windowDimensions,safeArea]);var rowRendererProp=props.rowRenderer,data=props.data;var dataProvider=useMemo(function(){return new DataProvider(function(r1,r2){if(r1.id!==r2.id){return true;}return false;});},[]);var _useState=useState(dataProvider),_useState2=_slicedToArray(_useState,2),messages=_useState2[0],setMessages=_useState2[1];var previousMessages=usePrevious(messages);useEffect(function(){setMessages(dataProvider.cloneWithRows(data));},[data,dataProvider]);useEffect(function(){ChatBubbleEmitter.addListener('replyBubblePressed',function(messageId){var index=messages.getAllData().findIndex(function(m){return m.id===messageId;});if(index!==-1){var _recyclerlistviewRef$;(_recyclerlistviewRef$=recyclerlistviewRef.current)===null||_recyclerlistviewRef$===void 0?void 0:_recyclerlistviewRef$.scrollToIndex(index,true);}});return function(){ChatBubbleEmitter.removeAllListeners();};},[messages]);useImperativeHandle(ref,function(){return{appendMessage:function appendMessage(message,firstIndex){if(firstIndex){if(Array.isArray(message)){setMessages(dataProvider.cloneWithRows([].concat(_toConsumableArray(message),_toConsumableArray(messages.getAllData()))));}else{setMessages(dataProvider.cloneWithRows([message].concat(_toConsumableArray(messages.getAllData()))));}}else{if(Array.isArray(message)){setMessages(dataProvider.cloneWithRows([].concat(_toConsumableArray(messages.getAllData()),_toConsumableArray(message))));}else{setMessages(dataProvider.cloneWithRows([].concat(_toConsumableArray(messages.getAllData()),[message])));}}if(!Array.isArray(message)){if(!message.me&&propsContext!==null&&propsContext!==void 0&&propsContext.enableHapticFeedback){if(Platform.OS!=='web'&&hapticEngine)trigger(HapticType.Heavy);}}},scrollToEnd:function scrollToEnd(animated){var _recyclerlistviewRef$2;(_recyclerlistviewRef$2=recyclerlistviewRef.current)===null||_recyclerlistviewRef$2===void 0?void 0:_recyclerlistviewRef$2.scrollToEnd(animated);},setIsTyping:function setIsTyping(typing){var _typingStatusRef$curr,_recyclerlistviewRef$3;(_typingStatusRef$curr=typingStatusRef.current)===null||_typingStatusRef$curr===void 0?void 0:_typingStatusRef$curr.setIsTyping(typing!==null&&typing!==void 0?typing:false);(_recyclerlistviewRef$3=recyclerlistviewRef.current)===null||_recyclerlistviewRef$3===void 0?void 0:_recyclerlistviewRef$3.scrollToEnd(true);},removeMessage:function removeMessage(id){setMessages(dataProvider.cloneWithRows(messages.getAllData().filter(function(message){return message.id!==id;})));}};},[dataProvider,messages,propsContext.enableHapticFeedback,trigger]);useEffect(function(){var _,_2;if(previousMessages&&((_=previousMessages.getAllData()[0])===null||_===void 0?void 0:_.id)===((_2=messages.getAllData()[0])===null||_2===void 0?void 0:_2.id)){wait(100).then(function(){var _recyclerlistviewRef$4;(_recyclerlistviewRef$4=recyclerlistviewRef.current)===null||_recyclerlistviewRef$4===void 0?void 0:_recyclerlistviewRef$4.scrollToEnd(true);});}},[ref,messages,previousMessages]);var layoutProvider=useCallback(function(){return new LayoutProvider(function(index){var currentMessage=messages.getAllData()[index];var prevMessage=messages.getAllData()[index-1];if(currentMessage.text.length>=600){return LayoutType.ExtremeLong;}if(currentMessage.text.length>=400){return LayoutType.Long3x;}if(currentMessage.text.length>=200){return LayoutType.Long2x;}if(currentMessage.text.length>=100){return LayoutType.Long;}if(currentMessage!==null&&currentMessage!==void 0&&currentMessage.media){if(currentMessage.media.length>2){return LayoutType.Media2x;}return LayoutType.Media;}if(currentMessage.repliedTo){return LayoutType.Replied;}var isFirstMessage=index===0;if(!isFirstMessage&&dayjs(currentMessage.createdAt).date()!==dayjs(prevMessage.createdAt).date()||isFirstMessage){return LayoutType.Dated;}return LayoutType.Normal;},function(type,dim){dim.width=windowDimensions.width;switch(type){case LayoutType.Normal:dim.height=85;break;case LayoutType.Replied:dim.height=190;break;case LayoutType.Dated:dim.height=110;break;case LayoutType.Long:dim.height=130;break;case LayoutType.Long2x:dim.height=170;break;case LayoutType.Long3x:dim.height=350;break;case LayoutType.ExtremeLong:dim.height=550;break;case LayoutType.Media:dim.height=180;break;case LayoutType.Media2x:dim.height=300;break;default:dim.height=85;break;}});},[messages,windowDimensions.width]);var renderBubble=useCallback(function(data,withDate){if(rowRendererProp){return React.createElement(View,null,withDate&&React.createElement(RenderDate,_extends({date:data.createdAt},propsContext.renderDateProps)),React.createElement(Animated.View,{entering:FadeInDown,exiting:FadeOutUp},React.createElement(SwipeableBubble,{message:data,onReply:propsContext.onReply},rowRendererProp(data))));}return React.createElement(View,{style:{width:'100%'}},withDate&&React.createElement(RenderDate,_extends({date:data.createdAt},propsContext.renderDateProps)),React.createElement(Animated.View,{entering:FadeInDown,exiting:FadeOutUp},propsContext.onReply?React.createElement(React.Fragment,null,React.createElement(SwipeableBubble,{message:data,onReply:propsContext.onReply})):React.createElement(ChatBubble,{message:data})));},[propsContext.onReply,propsContext.renderDateProps,rowRendererProp]);var rowRenderer=useCallback(function(type,data){if(type===LayoutType.Dated){return renderBubble(data,true);}return renderBubble(data);},[renderBubble]);var onScroll=useCallback(function(e,offsetX,offsetY){if(e.nativeEvent.contentOffset.y<=0){var _fabRef$current;(_fabRef$current=fabRef.current)===null||_fabRef$current===void 0?void 0:_fabRef$current.show();}else{var _fabRef$current2;(_fabRef$current2=fabRef.current)===null||_fabRef$current2===void 0?void 0:_fabRef$current2.hide();}if(props.onScroll){props.onScroll(e,offsetX,offsetY);}},[props]);var scrollToBottom=useCallback(function(){var _recyclerlistviewRef$5;(_recyclerlistviewRef$5=recyclerlistviewRef.current)===null||_recyclerlistviewRef$5===void 0?void 0:_recyclerlistviewRef$5.scrollToEnd(true);},[]);return React.createElement(View,{style:{minWidth:1,minHeight:1,maxHeight:listHeight}},propsContext.showScrollToBottomButton&&React.createElement(FAB,_extends({ref:fabRef,onPress:scrollToBottom},propsContext.scrollToBottomProps)),React.createElement(RecyclerListView,{layoutProvider:layoutProvider(),externalScrollView:ScrollViewWithHeader,dataProvider:messages,style:[{height:propsContext.replyingTo?'90%':'100%'},props.containerStyle],ref:recyclerlistviewRef,scrollViewProps:{keyboardShouldPersistTaps:'never'},onScroll:onScroll,optimizeForInsertDeleteAnimations:true,forceNonDeterministicRendering:true,canChangeSize:true,rowRenderer:rowRenderer,renderFooter:function renderFooter(){return React.createElement(TypingStatus,{ref:typingStatusRef});},onEndReached:props===null||props===void 0?void 0:props.onEndReached,onEndReachedThreshold:props===null||props===void 0?void 0:props.onEndReachedThreshold}));});","map":{"version":3,"mappings":"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","names":["dayjs","React","useCallback","useContext","useEffect","useImperativeHandle","useMemo","useRef","useState","Animated","FadeInDown","FadeOutUp","useSafeAreaInsets","DataProvider","LayoutProvider","RecyclerListView","ChatBubble","PropsContext","FAB","LoadEarlier","RenderDate","TypingStatus","useHaptic","usePrevious","SwipeableBubble","HapticType","LayoutType","ChatBubbleEmitter","hapticEngine","wait","ScrollViewWithHeader","forwardRef","ref","children","props","propsContext","ScrollView","loadEarlierProps","show","List","recyclerlistviewRef","windowDimensions","useWindowDimensions","safeArea","trigger","fabRef","typingStatusRef","listHeight","height","bottom","top","rowRendererProp","rowRenderer","data","dataProvider","r1","r2","id","messages","setMessages","previousMessages","cloneWithRows","addListener","messageId","index","getAllData","findIndex","m","current","scrollToIndex","removeAllListeners","appendMessage","message","firstIndex","Array","isArray","me","enableHapticFeedback","Platform","OS","Heavy","scrollToEnd","animated","setIsTyping","typing","removeMessage","filter","_2","then","layoutProvider","currentMessage","prevMessage","text","length","ExtremeLong","Long3x","Long2x","Long","media","Media2x","Media","repliedTo","Replied","isFirstMessage","createdAt","date","Dated","Normal","type","dim","width","renderBubble","withDate","View","renderDateProps","entering","exiting","onReply","style","onScroll","e","offsetX","offsetY","nativeEvent","contentOffset","y","hide","scrollToBottom","minWidth","minHeight","maxHeight","showScrollToBottomButton","onPress","scrollToBottomProps","externalScrollView","replyingTo","containerStyle","scrollViewProps","keyboardShouldPersistTaps","optimizeForInsertDeleteAnimations","forceNonDeterministicRendering","canChangeSize","renderFooter","onEndReached","onEndReachedThreshold"],"sources":["List.tsx"],"sourcesContent":["import dayjs from 'dayjs';\nimport type { ForwardedRef, Ref } from 'react';\nimport React, {\n  useCallback,\n  useContext,\n  useEffect,\n  useImperativeHandle,\n  useMemo,\n  useRef,\n  useState,\n} from 'react';\nimport { Platform, ScrollView, useWindowDimensions, View } from 'react-native';\nimport Animated, { FadeInDown, FadeOutUp } from 'react-native-reanimated';\nimport { useSafeAreaInsets } from 'react-native-safe-area-context';\nimport {\n  DataProvider,\n  LayoutProvider,\n  RecyclerListView,\n} from 'recyclerlistview';\nimport type { ScrollEvent } from 'recyclerlistview/dist/reactnative/core/scrollcomponent/BaseScrollView';\nimport { ChatBubble } from './ChatBubble';\nimport { PropsContext } from './Chatty';\nimport { FAB, IFabRef } from './components/FAB';\nimport { LoadEarlier } from './components/LoadEarlier';\nimport { RenderDate } from './components/RenderDate';\nimport { TypingStatus } from './components/TypingStatus';\nimport { useHaptic } from './hooks/useHaptic';\nimport { usePrevious } from './hooks/usePrevious';\nimport { SwipeableBubble } from './SwipeableBubble';\nimport {\n  HapticType,\n  IListProps,\n  IMessage,\n  ITypingStatusRef,\n  LayoutType,\n  ListRef,\n} from './types/Chatty.types';\nimport { ChatBubbleEmitter } from './utils/eventEmitter';\nimport { hapticEngine } from './utils/hapticEngine';\nimport { wait } from './utils/helpers';\n\nconst ScrollViewWithHeader = React.forwardRef(\n  ({ children, ...props }, ref: Ref<ScrollView>) => {\n    const propsContext = useContext(PropsContext);\n\n    return (\n      <ScrollView ref={ref} {...props}>\n        {propsContext?.loadEarlierProps &&\n          propsContext.loadEarlierProps.show && (\n            <LoadEarlier {...propsContext.loadEarlierProps} />\n          )}\n        {children}\n      </ScrollView>\n    );\n  }\n);\n\nexport const List = React.forwardRef(\n  (props: IListProps, ref: ForwardedRef<ListRef>) => {\n    const propsContext = useContext(PropsContext);\n    const recyclerlistviewRef = useRef<RecyclerListView<any, any>>();\n    const windowDimensions = useWindowDimensions();\n    const safeArea = useSafeAreaInsets();\n    const { trigger } = useHaptic();\n    const fabRef = useRef<IFabRef>(null);\n    const typingStatusRef = useRef<ITypingStatusRef>(null);\n    const listHeight = useMemo(\n      () => windowDimensions.height - 150 - safeArea.bottom - safeArea.top,\n      [windowDimensions, safeArea]\n    );\n    const { rowRenderer: rowRendererProp, data } = props;\n\n    const dataProvider = useMemo<DataProvider>(() => {\n      return new DataProvider((r1: IMessage, r2: IMessage) => {\n        if (r1.id !== r2.id) {\n          return true;\n        }\n\n        return false;\n      });\n    }, []);\n\n    const [messages, setMessages] = useState<DataProvider>(dataProvider);\n    const previousMessages = usePrevious<DataProvider>(messages);\n\n    /* This is a React Hook that is used to update the messages list when new messages are added. */\n    useEffect(() => {\n      setMessages(dataProvider.cloneWithRows(data));\n    }, [data, dataProvider]);\n\n    /* This code is listening to the event of a reply bubble being pressed. When it is pressed, it scrolls\nto the replied message. */\n    useEffect(() => {\n      // When reply is pressed, scroll to replied message\n      ChatBubbleEmitter.addListener('replyBubblePressed', (messageId) => {\n        const index = messages\n          .getAllData()\n          .findIndex((m) => m.id === messageId);\n\n        if (index !== -1) {\n          recyclerlistviewRef.current?.scrollToIndex(index, true);\n        }\n      });\n\n      return () => {\n        ChatBubbleEmitter.removeAllListeners();\n      };\n    }, [messages]);\n\n    /* Using the useImperativeHandle hook to expose a function to the parent component that will allow\n    it to manipulate the messages list. */\n    useImperativeHandle(\n      ref,\n      () => ({\n        appendMessage: (\n          message: IMessage | IMessage[],\n          firstIndex?: boolean\n        ) => {\n          if (firstIndex) {\n            if (Array.isArray(message)) {\n              setMessages(\n                dataProvider.cloneWithRows([\n                  ...message,\n                  ...messages.getAllData(),\n                ])\n              );\n            } else {\n              setMessages(\n                dataProvider.cloneWithRows([message, ...messages.getAllData()])\n              );\n            }\n          } else {\n            if (Array.isArray(message)) {\n              setMessages(\n                dataProvider.cloneWithRows([\n                  ...messages.getAllData(),\n                  ...message,\n                ])\n              );\n            } else {\n              setMessages(\n                dataProvider.cloneWithRows([...messages.getAllData(), message])\n              );\n            }\n          }\n\n          if (!Array.isArray(message)) {\n            if (!message.me && propsContext?.enableHapticFeedback) {\n              if (Platform.OS !== 'web' && hapticEngine)\n                trigger(HapticType.Heavy);\n            }\n          }\n        },\n        /* This is a function that is used to scroll to the bottom of the list. */\n        scrollToEnd: (animated?: boolean) => {\n          recyclerlistviewRef.current?.scrollToEnd(animated);\n        },\n        /* Setting the typing status of the user. */\n        setIsTyping: (typing?: boolean) => {\n          typingStatusRef.current?.setIsTyping(typing ?? false);\n          recyclerlistviewRef.current?.scrollToEnd(true);\n        },\n        /* Removing a message from the list of messages. */\n        removeMessage: (id: number) => {\n          setMessages(\n            dataProvider.cloneWithRows(\n              messages.getAllData().filter((message) => message.id !== id)\n            )\n          );\n        },\n      }),\n      [dataProvider, messages, propsContext.enableHapticFeedback, trigger]\n    );\n\n    /* This code is checking if the first message in the previous messages is the same as the first message\nin the current messages. If it is, then it will not scroll to the bottom. */\n    useEffect(() => {\n      if (\n        previousMessages &&\n        previousMessages.getAllData()![0]?.id === messages.getAllData()![0]?.id\n      ) {\n        wait(100).then(() => {\n          recyclerlistviewRef.current?.scrollToEnd(true);\n        });\n      }\n    }, [ref, messages, previousMessages]);\n\n    const layoutProvider = useCallback(() => {\n      return new LayoutProvider(\n        (index) => {\n          const currentMessage: IMessage = messages.getAllData()[index];\n          const prevMessage: IMessage = messages.getAllData()[index - 1];\n\n          if (currentMessage.text.length >= 600) {\n            return LayoutType.ExtremeLong;\n          }\n\n          if (currentMessage.text.length >= 400) {\n            return LayoutType.Long3x;\n          }\n\n          if (currentMessage.text.length >= 200) {\n            return LayoutType.Long2x;\n          }\n\n          if (currentMessage.text.length >= 100) {\n            return LayoutType.Long;\n          }\n\n          if (currentMessage?.media) {\n            if (currentMessage.media.length > 2) {\n              return LayoutType.Media2x;\n            }\n\n            return LayoutType.Media;\n          }\n\n          if (currentMessage.repliedTo) {\n            return LayoutType.Replied;\n          }\n\n          const isFirstMessage = index === 0;\n\n          if (\n            (!isFirstMessage &&\n              dayjs(currentMessage.createdAt).date() !==\n                dayjs(prevMessage.createdAt).date()) ||\n            isFirstMessage\n          ) {\n            return LayoutType.Dated;\n          }\n\n          return LayoutType.Normal;\n        },\n        (type, dim) => {\n          dim.width = windowDimensions.width;\n\n          switch (type) {\n            case LayoutType.Normal:\n              dim.height = 85;\n              break;\n            case LayoutType.Replied:\n              dim.height = 190;\n              break;\n            case LayoutType.Dated:\n              dim.height = 110;\n              break;\n            case LayoutType.Long:\n              dim.height = 130;\n              break;\n            case LayoutType.Long2x:\n              dim.height = 170;\n              break;\n            case LayoutType.Long3x:\n              dim.height = 350;\n              break;\n            case LayoutType.ExtremeLong:\n              dim.height = 550;\n              break;\n            case LayoutType.Media:\n              dim.height = 180;\n              break;\n            case LayoutType.Media2x:\n              dim.height = 300;\n              break;\n\n            default:\n              dim.height = 85;\n              break;\n          }\n        }\n      );\n    }, [messages, windowDimensions.width]);\n\n    const renderBubble = useCallback(\n      (data: IMessage, withDate?: boolean) => {\n        if (rowRendererProp) {\n          return (\n            <View>\n              {withDate && (\n                <RenderDate\n                  date={data.createdAt}\n                  {...propsContext.renderDateProps}\n                />\n              )}\n\n              <Animated.View entering={FadeInDown} exiting={FadeOutUp}>\n                <SwipeableBubble message={data} onReply={propsContext.onReply}>\n                  {rowRendererProp(data)}\n                </SwipeableBubble>\n              </Animated.View>\n            </View>\n          );\n        }\n\n        return (\n          <View style={{ width: '100%' }}>\n            {withDate && (\n              <RenderDate\n                date={data.createdAt}\n                {...propsContext.renderDateProps}\n              />\n            )}\n            <Animated.View entering={FadeInDown} exiting={FadeOutUp}>\n              {propsContext.onReply ? (\n                <>\n                  <SwipeableBubble\n                    message={data}\n                    onReply={propsContext.onReply}\n                  />\n                </>\n              ) : (\n                <ChatBubble message={data} />\n              )}\n            </Animated.View>\n          </View>\n        );\n      },\n      [propsContext.onReply, propsContext.renderDateProps, rowRendererProp]\n    );\n\n    const rowRenderer = useCallback(\n      (type, data: IMessage) => {\n        if (type === LayoutType.Dated) {\n          return renderBubble(data, true);\n        }\n\n        return renderBubble(data);\n      },\n      [renderBubble]\n    );\n\n    const onScroll = useCallback(\n      (e: ScrollEvent, offsetX: number, offsetY: number) => {\n        if (e.nativeEvent.contentOffset.y <= 0) {\n          fabRef.current?.show();\n        } else {\n          fabRef.current?.hide();\n        }\n\n        if (props.onScroll) {\n          props.onScroll(e, offsetX, offsetY);\n        }\n      },\n      [props]\n    );\n\n    const scrollToBottom = useCallback(() => {\n      recyclerlistviewRef.current?.scrollToEnd(true);\n    }, []);\n\n    return (\n      <View style={{ minWidth: 1, minHeight: 1, maxHeight: listHeight }}>\n        {propsContext.showScrollToBottomButton && (\n          <FAB\n            ref={fabRef}\n            onPress={scrollToBottom}\n            {...propsContext.scrollToBottomProps}\n          />\n        )}\n\n        <RecyclerListView\n          layoutProvider={layoutProvider()}\n          externalScrollView={ScrollViewWithHeader}\n          dataProvider={messages}\n          style={[\n            {\n              height: propsContext.replyingTo ? '90%' : '100%',\n            },\n            props.containerStyle,\n          ]}\n          // @ts-ignore\n          ref={recyclerlistviewRef}\n          scrollViewProps={{\n            keyboardShouldPersistTaps: 'never',\n          }}\n          onScroll={onScroll}\n          optimizeForInsertDeleteAnimations\n          forceNonDeterministicRendering\n          canChangeSize={true}\n          rowRenderer={rowRenderer}\n          renderFooter={() => <TypingStatus ref={typingStatusRef} />}\n          onEndReached={props?.onEndReached}\n          onEndReachedThreshold={props?.onEndReachedThreshold}\n        />\n      </View>\n    );\n  }\n);\n"]},"metadata":{},"sourceType":"module"}